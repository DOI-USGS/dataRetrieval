---
title: "Introduction to New USGS Services"
author: Laura A. DeCicco
editor_options: 
  chunk_output_type: console
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Introduction to New USGS Services}
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
---


```{r setup, include=FALSE, message=FALSE}
library(knitr)
library(dataRetrieval)
library(dplyr)
library(ggplot2)

options(continue = " ",
        width = 50)

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.height = 4,
  fig.width = 7
)
```


As we bid adieu to the NWIS web services, we welcome a host of new web service offering: the [USGS Water Data OGC APIs](https://api.waterdata.usgs.gov/ogcapi/v0/). This is a modern access point for USGS water data. The USGS is planning to modernize **all** web services in the near future. For each of these updates, `dataRetrieval` will create a new function to access the new services. 

This document will introduce each new function (note as time goes on, we'll update this document to include additional functions). Scroll down for tips on what you'll need to do to convert your legacy scripts to use these modern functions. Note the timeline for the NWIS servers being shut down is currently very uncertain. We'd recommend incorporating these new functions as soon as possible to avoid future headaches.

# New Features

Each new "API endpoint" will deliver a new type of USGS data. Currently the available endpoints are "monitoring-locations", "time-series-metadata", and "daily". All of these new endpoints offer some new features that the NWIS services did not have:

* Users can pick which columns are returned with the "properties" argument. Available properties can be discovered with the `check_OGC_requests` function:

```{r}
daily_schema <- check_OGC_requests(endpoint = "daily", type = "schema")
names(daily_schema$properties)

```

* Any column that is returned can also be queried on! The main `dataRetrieval` functions will take vector inputs. Each query is appended as a boolean AND. For instance, if you ask for a vector of monitoring location ids and a vector of parameter codes, you will get data back for just those monitoring locations AND the specified parameter codes. Towards the bottom of this document, we'll discuss ways to make more specific queries using "Common Query Language" or CQL.

* Data is returned with a "geometry" column, which is a simple feature object, allowing the data to be integrated with the `sf` package and associated geospatial workflows.

* When you look at the help file for the new functions, youâ€™ll also notice there are many more arguments. These are mostly set by default to NA. You **DO NOT** need to (and most like should not!) specify all of these parameters. 

* You can register an API key for use with USGS water data APIs. There are now limits on how many queries can be requested per IP address per hour. If you find yourself running into limits, you can request an API token here: <https://api.waterdata.usgs.gov/signup/>

Then save your token in your .Renviron file like this:

```
API_USGS_PAT = "my_super_secret_token"
```

You can use `usethis::edit_r_environ()` to edit find and open your .Renviron file. You will need to restart R for that variable to be recognized. 

# Monitoring Location

The `read_USGS_monitoring_location` function replaces the `readNWISsite` function.

`r dataRetrieval:::get_description("monitoring-locations")`

To access these services on a web browser, go to <https://api.waterdata.usgs.gov/ogcapi/v0/collections/monitoring-locations>.

Here is a simple example of requesting one known USGS site:

```{r}
sites_information <- read_USGS_monitoring_location(monitoring_location_id = "USGS-01491000")
```

The output includes the following information:

```{r echo=FALSE}
knitr::kable(t(sites_information))
```

Maybe that is more information than you need. You can specify which columns get returned with the "properties" argument:

```{r}
site_info <- read_USGS_monitoring_location(monitoring_location_id = "USGS-01491000",
                                           properties = c("monitoring_locations_id",
                                                          "site_type",
                                                          "drainage_area",
                                                          "monitoring_location_name"))

knitr::kable(site_info)

```

Any of those original outputs can also be inputs to the function! So let's say we want to find all the stream sites in Wisconsin:

```{r}
sites_wi <- read_USGS_monitoring_location(state_name = "Wisconsin", 
                                          site_type = "Stream")
```

The returned data includes a column "geometry" which is a collection of simple feature (sf) points. This allows for seamless integration with the `sf` package. Here are 2 quick examples of using the `sf` object in ggplot2 and leaflet:

```{r}
library(ggplot2)

ggplot(data = sites_wi) +
  geom_sf() +
  theme_minimal()
```

```{r}
library(leaflet)
leaflet_crs <- "+proj=longlat +datum=WGS84" #default leaflet crs
leaflet(data = sites_wi |> 
                sf::st_transform(crs = leaflet_crs)) |> 
    addProviderTiles("CartoDB.Positron") |> 
    addCircleMarkers(popup = ~monitoring_location_name, 
                   radius = 0.1,
                   opacity = 1)

```

# Time Series Metadata

The `read_USGS_ts_meta` function replaces the `whatNWISdata` function.

`r dataRetrieval:::get_description("time-series-metadata")`

To access these services on a web browser, go to <https://api.waterdata.usgs.gov/ogcapi/v0/collections/time-series-metadata>.


```{r}
ts_available <- read_USGS_ts_meta(monitoring_location_id = "USGS-01491000",
                                  parameter_code = c("00060", "00010"))

```

The returning tables gives information on all available time series. For instance, we can pull a few columns out and see when each time series started, ended, or was last modified.

```{r echo=FALSE}
ts_available1 <- ts_available[,c("parameter_name", "statistic_id", "begin", "end", "last_modified")]
ts_available1 <- sf::st_drop_geometry(ts_available1)
ts_available1$begin <- as.Date(ts_available1$begin)
ts_available1$end <- as.Date(ts_available1$end)
ts_available1$last_modified <- as.Date(ts_available1$last_modified)
knitr::kable(ts_available1)

```

# Daily Values

The `read_USGS_daily` function replaces the `readNWISdv` function.

`r dataRetrieval:::get_description("daily")`

To access these services on a web browser, go to <https://api.waterdata.usgs.gov/ogcapi/v0/collections/daily>.



```{r}
library(dataRetrieval)

daily_modern <- read_USGS_daily(monitoring_location_id = "USGS-01491000",
                          parameter_code = c("00060", "00010"),
                          statistic_id = "00003",
                          time = c("2023-01-01", "2025-05-06"))

nrow(daily_modern)
```

The first thing you might notice is that the new service serves data in a "long" format, which means there is just a single observations per row of the data frame (see: [Pivot Data](articles/long_to_wide.html)). 

```{r}
library(ggplot2)
ggplot(data = daily_modern) +
  geom_point(aes(x = time, y = value, 
                 color = approval_status)) +
  facet_grid(parameter_code ~ ., scale = "free") +
  theme_bw()

```




# Notes on dataRetrieval development

## New Features

### Style

New functions will use a "snake case", such as "read_USGS_samples". Older functions use camel case, such as "readNWISdv". The difference is the underscore between words. This should be a handy way to tell the difference between newer modern data access, and the older traditional functions. 

### Structure

Historically, we allowed users to customize their queries via the `...` argument structure. With `...`, users needed to know the exact names of query parameters before using the function. Now, the new functions will include **ALL** possible arguments that the web service APIs support. This will allow users to use tab-autocompletes (available in RStudio and other IDEs). **Users will need to understand that they are not required to specify all of these parameters. In fact, it is not advisable: the systems can get bogged down with redundant query parameters.** We expect this will be easier for users, but it might take some time to smooth out the documentation and test usability. There may be additional consequences, such as users won't be able to build up argument lists to pass into the function.  

### Dependencies

Under the hood, `dataRetrieval` changed the dependency from `httr` to `httr2`. `httr2` is the modern R package for web requests that is actively developed/maintained. As we develop functions for the modern USGS web services, we'll continue to explore updating package dependencies. Since the new services offer geospatial output, we have recommend using the `sf` package. The `whisker` package was also included to help create POST CQL2 queries. 

## Developmental workflow

CRAN-stable documentation will be available on the GitHub pages:
<https://doi-usgs.github.io/dataRetrieval/>

In-development documentation will be available on the USGS GitLab pages:
<https://water.code-pages.usgs.gov/dataRetrieval>

Development of `dataRetrieval` will happen on a git branch called "develop". The "develop" branch will only move to the "main" branch when we submit to CRAN, unless there are bug fixes that pertain to the CRAN release. The "develop" branch WILL change frequently, and there are no promises of future behavior. Users must accept that they are using those functions at their own risk. If you willing to accept this risk, the installation instructions are:

```{r eval=FALSE}
library(remotes)

install_github("DOI-USGS/dataRetrieval",
               ref = "develop")

```

