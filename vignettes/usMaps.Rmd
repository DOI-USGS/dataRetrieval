---
title: "Map Stuff"
author: "Laura DeCicco"
date: "2019-04-05"
output: 
  rmarkdown::html_vignette:
    toc: true
    fig_height: 5
    fig_width: 7
vignette: >
  %\VignetteIndexEntry{Complete U.S. Maps}
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
library(knitr)

opts_chunk$set(
  echo=TRUE,
  warning = FALSE,
  message = FALSE
)
```

We're often tasked with plotting sites on a U.S. map that must include AK, HI, and PR. The following example uses the `sp`,`maps`, `maptools`, `rgeos`, and `ggplot2` packages to produce the information to plot points on a map. It was greatly inspired by Bob Rudis's blog [Moving The Earth (well, Alaska & Hawaii) With R](https://rud.is/b/2014/11/16/moving-the-earth-well-alaska-hawaii-with-r/).

First we convert the code to some reusable functions:

```{r to_sp}
to_sp <- function(...){
  proj.string <- "+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"
  map <- maps::map(..., fill=TRUE, plot = FALSE)
  IDs <- sapply(strsplit(map$names, ":"), function(x) x[1])
  map.sp <- maptools::map2SpatialPolygons(map, 
                                          IDs=IDs,
                                          proj4string=sp::CRS("+proj=longlat +datum=WGS84"))
  map.sp.t <- sp::spTransform(map.sp, sp::CRS(proj.string))
  return(map.sp.t)
}
```

```{r shift}
shift_sp <- function(sp, scale, shift, 
                     rotate = 0, ref=sp, 
                     proj.string=NULL, row.names=NULL){
  orig.cent <- rgeos::gCentroid(ref, byid=TRUE)@coords
  scale <- max(apply(sp::bbox(ref), 1, diff)) * scale
  obj <- maptools::elide(sp, rotate=rotate, 
                         center=orig.cent, bb = sp::bbox(ref))
  ref <- maptools::elide(ref, rotate=rotate, 
                         center=orig.cent, bb = sp::bbox(ref))
  obj <- maptools::elide(obj, scale=scale, 
                         center=orig.cent, bb = sp::bbox(ref))
  ref <- maptools::elide(ref, scale=scale, 
                         center=orig.cent, bb = sp::bbox(ref))
  new.cent <- rgeos::gCentroid(ref, byid=TRUE)@coords
  obj <- maptools::elide(obj, shift=shift*10000 + c(orig.cent-new.cent))
  
  if (is.null(proj.string)){
    sp::proj4string(obj) <- sp::proj4string(sp)
  } else {
    sp::proj4string(obj) <- proj.string
  }
  
  if (!is.null(row.names)){
    row.names(obj) <- row.names
  }
  return(obj)
}

```

```{r resetstates}
reset_states <- function(move_variables, stuff_to_move){
  states.out <- to_sp("state")
  conus <- states.out
  for(i in names(move_variables)){
    shifted <- do.call(shift_sp, c(sp = stuff_to_move[[i]], 
                                   move_variables[[i]],  
                                   proj.string = sp::proj4string(conus),
                                   row.names = i))
    states.out <- rbind(shifted, states.out, makeUniqueIDs = TRUE)
    
  }
  return(states.out)
}

```

```{r resetPoints}
reset_points <- function(x, move_variables,stuff_to_move,
                          scale_by_color = TRUE, 
                          scale_by_size = FALSE){
  
  states.out <- to_sp("state")
  conus <- states.out
  
  coords = cbind(x$dec_long_va, x$dec_lat_va)
  
  sites = sp::SpatialPoints(coords, 
                            proj4string = sp::CRS("+init=epsg:4326")) %>% 
    sp::spTransform(sp::CRS(sp::proj4string(states.out)))

  sites.df <- as.data.frame(sites)
  
  for(i in names(move_variables)){

    if(any(x$state_abb == i)){
      
      shifted.sites <- do.call(shift_sp, c(sp = sites[x$state_abb == i,],
                                           move_variables[[i]],
                                           proj.string = sp::proj4string(conus),
                                           ref=stuff_to_move[[i]])) %>%
        as.data.frame %>% 
        sp::coordinates()
      
      sites.df[x$state_abb == i, ] <- shifted.sites
    }
  }
  
  sites.df$n <- x$scale

  return(sites.df)
  
}
```

```{r basicMap}
plot_points_on_map <- function(x, move_variables, stuff_to_move,
                               scale_by_color = TRUE, 
                               scale_by_size = FALSE){
  
  alpha_set <- 0.75
  base_fill <- "azure3"
  
  if(all(c("coords.x1","coords.x2", "n") %in% names(x))){
    sites.df <-  x
  } else {
    sites.df <-  reset_points(x, move_variables,stuff_to_move)
  }
  
  states.out <- reset_states(move_variables, stuff_to_move)
  
  gsMap <- ggplot() +
    geom_polygon(aes(x = long, y = lat, group = group),
                 data = states.out, fill = "grey90",
                 alpha = 0.1, color = "grey70") +
    theme_minimal() +
    theme(panel.grid = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank())
  
  if(scale_by_color & scale_by_size){
    gsMap <- gsMap +
      geom_point(data = sites.df, 
                 aes(x = coords.x1, y=coords.x2, 
                     fill = n, size = n),
                 alpha = alpha_set,
                 color="black",pch=21) 
  } else if (scale_by_color){
    gsMap <- gsMap +
      geom_point(data = sites.df, 
                 aes(x = coords.x1, y=coords.x2, 
                     fill = n), 
                 alpha = alpha_set,
                 size = 2, color="black",pch=21) 
  } else if (scale_by_size){
    gsMap <- gsMap +
      geom_point(data = sites.df, 
                 aes(x = coords.x1, y=coords.x2, 
                     size = n), fill=base_fill, 
                 alpha = alpha_set,
                 color="black",pch=21) 
  } else {
    gsMap <- gsMap +
      geom_point(data = sites.df, 
                 aes(x = coords.x1, y=coords.x2), 
                 size = 2, color="black",pch=21,
                 fill=base_fill, alpha = alpha_set)
  }
  return(gsMap)
}

```

We've fiddled with the scaling, shifting, and rotating to:

```{r stuffToMove}
move_variables <- list(
  AK = list(scale=0.47, shift = c(90,-465), rotate=-50),
  HI = list(scale=1.5, shift=c(520, -110), rotate=-35),
  PR = list(scale=3.5, shift = c(-130, 90), rotate=20)
)

stuff_to_move <- list(
  AK = to_sp("world", "USA:alaska"),
  HI = to_sp("world", "USA:hawaii"),
  PR = to_sp("world", "Puerto Rico")
)

```


Now, let's get some data from `dataRetrieval`:

```{r getSites}

library(dataRetrieval)
library(dplyr)

all_sites <- data.frame()
failed_sites <- c()

#Running this full code takes about 15 minutes:

for(i in stateCd$STUSAB[c(1:51,55)]){ 
  
  cat("Getting:",i,"\n")
  
  all_sites <- tryCatch({
      
    sites <- readNWISdata(service = "site", 
                            seriesCatalogOutput=TRUE,
                            siteType="ST",hasDataTypeCd="qw",
                            stateCd = i)
    
    sites_filtered <- sites %>%
      filter(data_type_cd == "qw") %>%
      filter(count_nu >= 40) %>%
      select(site_no, station_nm, dec_lat_va, dec_long_va, 
             begin_date, end_date) %>%
      distinct() %>%
      mutate(begin_date = as.Date(begin_date),
             end_date = as.Date(end_date),
             years = (end_date - begin_date)/365.25) %>%
      filter(years > 10) %>%
      mutate(state = i)
  
    bind_rows(all_sites, sites_filtered)
  },
  error=function(cond) {
    message("***************Errored on",i,"***********\n")
    return(all_sites)
  })

}

unique_sites <- all_sites %>%
  group_by(site_no, station_nm, dec_lat_va, dec_long_va) %>%
  top_n(1, years) %>%
  data.frame() %>%
  distinct()

```

```{r makeMap}
library(dplyr)
library(ggplot2)

x <- data.frame(dec_long_va = -89,
                          dec_lat_va = 45,
                          state_abb = "WI",
                          scale = 1, strings_as_factors = FALSE)
plot_points_on_map(x, move_variables, stuff_to_move)
```
