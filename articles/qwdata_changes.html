<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Changes to NWIS QW services • dataRetrieval</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Changes to NWIS QW services">
<meta property="og:description" content="dataRetrieval">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53797708-7"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53797708-7');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dataRetrieval</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.7.9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dataRetrieval.html">Background</a>
</li>
<li>
  <a href="../reference/index.html">Function Help</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tutorial.html">Tutorial</a>
    </li>
    <li>
      <a href="../articles/movingAverages.html">Moving Averages</a>
    </li>
    <li>
      <a href="../articles/statsServiceMap.html">Stat Service</a>
    </li>
    <li>
      <a href="../articles/earthquake.html">Earthquake Exploration</a>
    </li>
    <li>
      <a href="../articles/nldi.html">NLDI Interface</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USGS-R/dataRetrieval" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="qwdata_changes_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Changes to NWIS QW services</h1>
                        <h4 data-toc-skip class="author">Laura A. DeCicco</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/USGS-R/dataRetrieval/blob/master/vignettes/qwdata_changes.Rmd" class="external-link"><code>vignettes/qwdata_changes.Rmd</code></a></small>
      <div class="hidden name"><code>qwdata_changes.Rmd</code></div>

    </div>

    
    
<div id="changes-to-water-quality-services" class="section level1">
<h1 class="hasAnchor">
<a href="#changes-to-water-quality-services" class="anchor" aria-hidden="true"></a>Changes to water quality services</h1>
<p>There was a recent announcement that the NWIS water quality web services will be shut down in spring of 2022. What does this mean for <code>dataRetrieval</code> users? The water quality data will continue to be available, but it must be accessed from the <a href="https://www.waterqualitydata.us/" class="external-link">Water Quality Portal</a> rather than the NWIS services. There are 3 major <code>dataRetrieval</code> functions that will be affected: <code>readNWISqw</code>, <code>whatNWISdata</code>, and <code>readNWISdata</code>. This vignette will describe the most common workflows conversions needed to update existing scripts.</p>
<p>This vignette is being provided well in advance of any breaking changes, and more information and guidance will be provided. If you need more help than is provided here, please reach out to <a href="mailto:gs-w-IOW_PO_team@usgs.gov" class="email">gs-w-IOW_PO_team@usgs.gov</a></p>
<div id="readnwisqw" class="section level2">
<h2 class="hasAnchor">
<a href="#readnwisqw" class="anchor" aria-hidden="true"></a><code>readNWISqw</code>
</h2>
<p>Starting with version 2.7.9, users will notice a Warning message when using this function:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">site_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'04024430'</span>,<span class="st">'04024000'</span><span class="op">)</span>
<span class="va">parameterCd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'34247'</span>,<span class="st">'30234'</span>,<span class="st">'32104'</span>,<span class="st">'34220'</span><span class="op">)</span>
<span class="va">nwisData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readNWISqw.html">readNWISqw</a></span><span class="op">(</span><span class="va">site_ids</span>, <span class="va">parameterCd</span><span class="op">)</span></code></pre></div>
<pre><code>Warning message:                                                                                               
NWIS qw web services are being retired. Please see the vignette 
'Changes to NWIS QW services' for more information. </code></pre>
<p>Please don’t ignore this warning, the function will eventually be <em>removed</em> from the <code>dataRetrieval</code> package.</p>
<p>So…what do you do instead? The function you will need to move to is <code>readWQPqw</code>. First, you’ll need to convert the USGS site ID’s into something that the Water Quality Portal will accept. Luckily, that’s a single line pasting a prefix “USGS-”. Here’s an example:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wqpData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readWQPqw.html">readWQPqw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"USGS-"</span>, <span class="va">site_ids</span><span class="op">)</span>, <span class="va">parameterCd</span><span class="op">)</span></code></pre></div>
<p>Let’s compare the number of rows, number of columns, and attributes to each return:</p>
<table class="table table">
<tr>
<th>
NWIS
</th>
<th>
WQP
</th>
</tr>
<tr></tr>
<tr>
<td>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">nwisData</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 208</code></pre>
</td>
<td>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">wqpData</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 208</code></pre>
</td>
</tr>
<tr>
<td>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">nwisData</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 36</code></pre>
</td>
<td>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">wqpData</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 65</code></pre>
</td>
</tr>
<tr>
<td>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">nwisData</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "names"        "class"        "row.names"    "queryTime"    "url"         
##  [6] "headerInfo"   "comment"      "siteInfo"     "variableInfo" "header"</code></pre>
</td>
<td>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">wqpData</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "names"        "class"        "row.names"    "siteInfo"     "variableInfo"
## [6] "url"          "queryTime"</code></pre>
</td>
</tr>
</table>
<p>The same number of rows are returned (because at it’s core, it IS the same data), more columns in the Water Quality Portal output, and slightly different attributes. You can explore the differences of those attributes:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">site_NWIS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nwisData</span>, <span class="st">"siteInfo"</span><span class="op">)</span>
<span class="va">site_WQP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">wqpData</span>, <span class="st">"siteInfo"</span><span class="op">)</span>

<span class="va">param_NWIS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nwisData</span>, <span class="st">"variableInfo"</span><span class="op">)</span>
<span class="va">param_WQP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">wqpData</span>, <span class="st">"variableInfo"</span><span class="op">)</span></code></pre></div>
<p>The next big task is figuring out which columns from the WQP output map to the original columns from the NWIS output. The vast majority of workflows will not need to completely re-engineer the WQP output back into the NWIS format. Instead, look at your workflow and determine what columns from the original NWIS output are needed to preserve the integrity of the workflow.</p>
<p>Let’s use the <code>dplyr</code> package to pull out the columns are used in this example workflow, and make sure both NWIS and WQP are ordered in the same way.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>

<span class="va">nwisData_USED</span> <span class="op">&lt;-</span> <span class="va">nwisData</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site_no</span>, <span class="va">startDateTime</span>, <span class="va">parm_cd</span>,
         <span class="va">hyd_cond_cd</span>, <span class="va">remark_cd</span>, <span class="va">result_va</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">startDateTime</span>, <span class="va">parm_cd</span><span class="op">)</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nwisData_USED</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">site_no</th>
<th align="left">startDateTime</th>
<th align="left">parm_cd</th>
<th align="left">hyd_cond_cd</th>
<th align="left">remark_cd</th>
<th align="right">result_va</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">30234</td>
<td align="left">9</td>
<td align="left">&lt;</td>
<td align="right">0.16</td>
</tr>
<tr class="even">
<td align="left">04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">32104</td>
<td align="left">9</td>
<td align="left">&lt;</td>
<td align="right">0.16</td>
</tr>
<tr class="odd">
<td align="left">04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34220</td>
<td align="left">9</td>
<td align="left">&lt;</td>
<td align="right">0.02</td>
</tr>
<tr class="even">
<td align="left">04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34247</td>
<td align="left">9</td>
<td align="left">&lt;</td>
<td align="right">0.02</td>
</tr>
<tr class="odd">
<td align="left">04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">30234</td>
<td align="left">5</td>
<td align="left">&lt;</td>
<td align="right">0.16</td>
</tr>
<tr class="even">
<td align="left">04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">32104</td>
<td align="left">5</td>
<td align="left">&lt;</td>
<td align="right">0.16</td>
</tr>
</tbody>
</table>
<p>If we explore the output from WQP, we can try to find the columns that include the same information:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wqpData_USED</span> <span class="op">&lt;-</span> <span class="va">wqpData</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>site_no <span class="op">=</span> <span class="va">MonitoringLocationIdentifier</span>,
         startDateTime <span class="op">=</span> <span class="va">ActivityStartDateTime</span>,
         parm_cd <span class="op">=</span> <span class="va">USGSPCode</span>,
         hyd_cond_cd <span class="op">=</span> <span class="va">HydrologicCondition</span>,
         remark_cd <span class="op">=</span> <span class="va">ResultDetectionConditionText</span>,
         result_va <span class="op">=</span> <span class="va">ResultMeasureValue</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">startDateTime</span>, <span class="va">parm_cd</span><span class="op">)</span>
<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wqpData_USED</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">site_no</th>
<th align="left">startDateTime</th>
<th align="left">parm_cd</th>
<th align="left">hyd_cond_cd</th>
<th align="left">remark_cd</th>
<th align="right">result_va</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">30234</td>
<td align="left">Stable, normal stage</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">32104</td>
<td align="left">Stable, normal stage</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34220</td>
<td align="left">Stable, normal stage</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34247</td>
<td align="left">Stable, normal stage</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">30234</td>
<td align="left">Falling stage</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">32104</td>
<td align="left">Falling stage</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<p>Now we can start looking at the results and trying to decide how future workflows should be setup. Here are some decisions for this example that we can consider:</p>
<div id="censored-values" class="section level3">
<h3 class="hasAnchor">
<a href="#censored-values" class="anchor" aria-hidden="true"></a>Censored values</h3>
<p>The result_va in the NWIS service came back with a value. However, the data is actually censored, meaning we only know it’s below the detection limit. With some lazier coding, it might have been really easy to not realize these values are left-censored. So, while we could substitute the detection levels into the measured values if there’s an <code>NA</code> in the measured value, this might be a great time to update your workflow to handle censored values more robustly. We are probably interested in maintaining the detection level in another column.</p>
<p>For this theoretical workflow, let’s think about what we are trying to find out. Let’s say that we want to know if a value is “left-censored” or not. Maybe in this case, what would make the most sense is to have a column that is a logical TRUE/FALSE. For this example, there was only the text “Not Detected” in the “ResultDetectionConditionText” column PLEASE NOTE that other data may include different messages about detection conditions, you will need to examine your data carefully. Here’s an example from the <code>EGRET</code> package on how to decide if a “ResultDetectionConditionText” should be considered a censored value:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">censored_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Not Detected"</span>,
                   <span class="st">"Non-Detect"</span>,
                   <span class="st">"Non Detect"</span>,
                   <span class="st">"Detected Not Quantified"</span>,
                   <span class="st">"Below Quantification Limit"</span><span class="op">)</span>

<span class="va">wqpData_USED</span> <span class="op">&lt;-</span> <span class="va">wqpData</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>left_censored <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">censored_text</span>, collapse<span class="op">=</span><span class="st">"|"</span><span class="op">)</span>, 
                               <span class="va">ResultDetectionConditionText</span>,
                               ignore.case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>site_no <span class="op">=</span> <span class="va">MonitoringLocationIdentifier</span>,
         startDateTime <span class="op">=</span> <span class="va">ActivityStartDateTime</span>,
         parm_cd <span class="op">=</span> <span class="va">USGSPCode</span>,
         <span class="va">left_censored</span>,
         result_va <span class="op">=</span> <span class="va">ResultMeasureValue</span>,
         detection_level <span class="op">=</span> <span class="va">DetectionQuantitationLimitMeasure.MeasureValue</span>,
         dl_units <span class="op">=</span> <span class="va">DetectionQuantitationLimitMeasure.MeasureUnitCode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">startDateTime</span>, <span class="va">parm_cd</span><span class="op">)</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wqpData_USED</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">site_no</th>
<th align="left">startDateTime</th>
<th align="left">parm_cd</th>
<th align="left">left_censored</th>
<th align="right">result_va</th>
<th align="right">detection_level</th>
<th align="left">dl_units</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">30234</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.16</td>
<td align="left">ug/l</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">32104</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.16</td>
<td align="left">ug/l</td>
</tr>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34220</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.02</td>
<td align="left">ug/l</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34247</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.02</td>
<td align="left">ug/l</td>
</tr>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">30234</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.16</td>
<td align="left">ug/l</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">32104</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.16</td>
<td align="left">ug/l</td>
</tr>
</tbody>
</table>
</div>
<div id="nwis-codes" class="section level3">
<h3 class="hasAnchor">
<a href="#nwis-codes" class="anchor" aria-hidden="true"></a>NWIS codes</h3>
<p>Another difference that is going to require some thoughtful decisions is how to interpret additional NWIS codes. They will now be descriptive text. Columns such as hyd_cond_cd, samp_type_cd, hyd_event_cd, medium_cd will now all be reported with descriptive words rather than single letters or numbers. It will be the responsibility of the user to consider the best way to deal with these changes.</p>
<p>To take full advantage of the Water Quality Portal, it would be a good idea to begin to move away from USGS parameter codes. While USGS data includes a parameter code, there are many other water quality data sources within the Water Quality Portal. To compare USGS and non-USGS data, you’ll need to compare data that has at least the same characteristic name and measured units. There are many other fields that may be required to assure you are comparing apples-to-apples. For example, “ResultSampleFractionText” is important in many measured parameters.</p>
<p>The measurement units are found in EITHER the “ResultMeasure.MeasureUnitCode” column, OR the “DetectionQuantitationLimitMeasure.MeasureUnitCode” column, depending on if the individual measurement is censored or not.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wqpData_USED_codes</span> <span class="op">&lt;-</span> <span class="va">wqpData</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ResultMeasure.MeasureUnitCode</span><span class="op">)</span>,
                             <span class="va">DetectionQuantitationLimitMeasure.MeasureUnitCode</span>,
                             <span class="va">ResultMeasure.MeasureUnitCode</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>parm_cd <span class="op">=</span> <span class="va">USGSPCode</span>,
         <span class="va">CharacteristicName</span>,<span class="va">ResultSampleFractionText</span>,
         <span class="va">units</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">wqpData_USED_codes</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">parm_cd</th>
<th align="left">CharacteristicName</th>
<th align="left">ResultSampleFractionText</th>
<th align="left">units</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">30234</td>
<td align="left">Bromacil</td>
<td align="left">Recoverable</td>
<td align="left">ug/l</td>
</tr>
<tr class="even">
<td align="left">32104</td>
<td align="left">Tribromomethane</td>
<td align="left">Recoverable</td>
<td align="left">ug/l</td>
</tr>
<tr class="odd">
<td align="left">34220</td>
<td align="left">Anthracene</td>
<td align="left">Recoverable</td>
<td align="left">ug/l</td>
</tr>
<tr class="even">
<td align="left">34247</td>
<td align="left">Benzo[a]pyrene</td>
<td align="left">Recoverable</td>
<td align="left">ug/l</td>
</tr>
</tbody>
</table>
<p>If there are USGS codes that you are using in your analysis, begin to move away from those codes, and move to the text. In the data we are looking at here:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wqpData_USED_codes</span> <span class="op">&lt;-</span> <span class="va">wqpData</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">HydrologicCondition</span>,<span class="va">HydrologicEvent</span>,
         <span class="va">ActivityTypeCode</span>, <span class="va">ActivityMediaName</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wqpData_USED_codes</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">HydrologicCondition</th>
<th align="left">HydrologicEvent</th>
<th align="left">ActivityTypeCode</th>
<th align="left">ActivityMediaName</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Stable, low stage</td>
<td align="left">Routine sample</td>
<td align="left">Sample-Routine</td>
<td align="left">Water</td>
</tr>
<tr class="even">
<td align="left">Rising stage</td>
<td align="left">Storm</td>
<td align="left">Sample-Routine</td>
<td align="left">Water</td>
</tr>
<tr class="odd">
<td align="left">Stable, normal stage</td>
<td align="left">Routine sample</td>
<td align="left">Sample-Routine</td>
<td align="left">Water</td>
</tr>
<tr class="even">
<td align="left">Falling stage</td>
<td align="left">Routine sample</td>
<td align="left">Sample-Routine</td>
<td align="left">Water</td>
</tr>
<tr class="odd">
<td align="left">Stable, normal stage</td>
<td align="left">Under ice cover</td>
<td align="left">Sample-Routine</td>
<td align="left">Water</td>
</tr>
<tr class="even">
<td align="left">Stable, normal stage</td>
<td align="left">Spring breakup</td>
<td align="left">Sample-Routine</td>
<td align="left">Water</td>
</tr>
</tbody>
</table>
<p>To convert the codes found in this example:</p>
<table class="table">
<thead><tr class="header">
<th align="left">NWIS</th>
<th align="left">WQP</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">samp_type_cd = 9</td>
<td align="left">ActivityTypeCode = “Sample-Routine”</td>
</tr>
<tr class="even">
<td align="left">hyd_cond_cd = 9</td>
<td align="left">HydrologicCondition = “Stable, normal stage”</td>
</tr>
<tr class="odd">
<td align="left">hyd_cond_cd = 5</td>
<td align="left">HydrologicCondition = “Falling stage”</td>
</tr>
<tr class="even">
<td align="left">hyd_cond_cd = 8</td>
<td align="left">HydrologicCondition = “Rising stage”</td>
</tr>
<tr class="odd">
<td align="left">medium_cd = “WS”</td>
<td align="left">ActivityMediaName = “Water”</td>
</tr>
<tr class="even">
<td align="left">hyd_event_cd = “B”</td>
<td align="left">HydrologicEvent = “Under ice cover”</td>
</tr>
<tr class="odd">
<td align="left">hyd_event_cd = “A”</td>
<td align="left">HydrologicEvent = “Spring breakup”</td>
</tr>
<tr class="even">
<td align="left">hyd_event_cd = 9</td>
<td align="left">HydrologicEvent = “Routine sample”</td>
</tr>
</tbody>
</table>
<p>If you use the <code>readNWISqw</code> function, you WILL need to adjust your workflows, and you may find there are more codes you will need to account for. Hopefully this section helped get you started. It does not include every scenario, so you may find more columns or codes or other conditions you need to account for.</p>
</div>
</div>
</div>
<div id="whatnwisdata" class="section level1">
<h1 class="hasAnchor">
<a href="#whatnwisdata" class="anchor" aria-hidden="true"></a>whatNWISdata</h1>
<p>This function will continue to work for any service except “qw” (water quality discrete data). “qw” results will no longer be returned. This function is used to discover what water quality data is available.</p>
<p>The function to replace this functionality is <code>whatWQPdata</code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">whatNWIS</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/whatNWISdata.html">whatNWISdata</a></span><span class="op">(</span>siteNumber <span class="op">=</span> <span class="va">site_ids</span>,
                       service <span class="op">=</span> <span class="st">"qw"</span><span class="op">)</span></code></pre></div>
<pre><code>Warning message:                                                                                               
NWIS qw web services are being retired. Please see the vignette 
'Changes to NWIS QW services' for more information.</code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">whatWQP</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/whatWQPdata.html">whatWQPdata</a></span><span class="op">(</span>siteNumber <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"USGS-"</span>, <span class="va">site_ids</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>There are some major differences in the output. The NWIS services offers back one row per site/parameter code to learn how many samples are available. This is not <em>currently</em> available from the Water Quality Portal, however there are new summary services being developed. When those become available, we will include new documentation on how to get this information.</p>
</div>
<div id="readnwisdata" class="section level1">
<h1 class="hasAnchor">
<a href="#readnwisdata" class="anchor" aria-hidden="true"></a>readNWISdata</h1>
<p>If you get your water quality data from the <code>readNWISdata</code> function, you will receive a warning. Note, this is <em>only</em> for the “qwdata” service. All other web services are not being deprecated, and should receive no warning.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">qwData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readNWISdata.html">readNWISdata</a></span><span class="op">(</span>state_cd <span class="op">=</span> <span class="st">"WI"</span>,
                       startDate <span class="op">=</span> <span class="st">"2000-01-01"</span>,
                       drain_area_va_min <span class="op">=</span> <span class="fl">50</span>, qw_count_nu<span class="op">=</span><span class="fl">50</span>, 
                       qw_attributes<span class="op">=</span><span class="st">"expanded"</span>,
                       qw_sample_wide<span class="op">=</span><span class="st">"wide"</span>,
                       list_of_search_criteria <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"state_cd"</span>,
                                                   <span class="st">"drain_area_va"</span>,
                                                   <span class="st">"obs_count_nu"</span><span class="op">)</span>,
                       service<span class="op">=</span><span class="st">"qw"</span><span class="op">)</span></code></pre></div>
<pre><code>Warning message:
NWIS qw web services are being retired. Please see the vignette 
'Changes to NWIS QW services' for more information. </code></pre>
<p>This is not an especially common <code>dataRetrieval</code> workflow, so there are not a lot of details here. Please reach out if more information is needed to update your workflows.</p>
<p>See <code><a href="../reference/readWQPdata.html">?readWQPdata</a></code> to see all the ways to query data in the Water Quality Portal. Use the suggestions above to convert the output of the <code>readWQPdata</code> function to convert the WQP output to what is important for your workflow.</p>
</div>
<div id="how-to-find-more-help" class="section level1">
<h1 class="hasAnchor">
<a href="#how-to-find-more-help" class="anchor" aria-hidden="true"></a>How to find more help</h1>
<p>These changes are big, and initially sound overwhelming. But in the end, they are thoughtful changes that will make understanding USGS water data more intuitive. Please reach out for questions and comments to: <a href="mailto:gs-w-IOW_PO_team@usgs.gov" class="email">gs-w-IOW_PO_team@usgs.gov</a></p>
</div>
<div id="disclaimer" class="section level1">
<h1 class="hasAnchor">
<a href="#disclaimer" class="anchor" aria-hidden="true"></a>Disclaimer</h1>
<p>This information is preliminary and is subject to revision. It is being provided to meet the need for timely best science. The information is provided on the condition that neither the U.S. Geological Survey nor the U.S. Government may be held liable for any damages resulting from the authorized or unauthorized use of the information.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Laura DeCicco, Robert Hirsch, David Lorenz, David Watkins, Mike Johnson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
