<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="dataRetrieval">
<title>Large Data Pulls from Water Quality Portal - A Pipeline-Based Approach • dataRetrieval</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Large Data Pulls from Water Quality Portal - A Pipeline-Based Approach">
<meta property="og:description" content="dataRetrieval">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53797708-7"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53797708-7');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://www.usgs.gov/" class="external-link"><img src="logo.png" id="logo" alt="Home" style="padding: 0px 50px 0px 0px;"></a>
    <a class="navbar-brand me-2" href="../index.html">dataRetrieval</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.7.12</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/dataRetrieval.html">Background</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Function Help</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-large-data-pull-examples">Large Data Pull Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-large-data-pull-examples">
    <a class="dropdown-item" href="../articles/wqp_large_pull_script.html">Scripting Approach</a>
    <a class="dropdown-item" href="../articles/wqp_large_pull_targets.html">Pipeline Approach</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/tutorial.html">Tutorial</a>
    <a class="dropdown-item" href="../articles/qwdata_changes.html">Changes to QW</a>
    <a class="dropdown-item" href="../articles/movingAverages.html">Moving Averages</a>
    <a class="dropdown-item" href="../articles/statsServiceMap.html">Stat Service</a>
    <a class="dropdown-item" href="../articles/nldi.html">NLDI Interface</a>
    <a class="dropdown-item" href="../articles/Contributing.html">How to Contribute</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/DOI-USGS/dataRetrieval">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Large Data Pulls from Water Quality Portal - A Pipeline-Based Approach</h1>
                        <h4 data-toc-skip class="author">Lauren Koenig
(she/her)</h4>
                        <h4 data-toc-skip class="author">Lindsay Platt
(she/her)</h4>
                        <h4 data-toc-skip class="author">Julie Padilla
(she/her)</h4>
            
            <h4 data-toc-skip class="date">2022-09-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DOI-USGS/dataRetrieval/blob/HEAD/vignettes/wqp_large_pull_targets.Rmd" class="external-link"><code>vignettes/wqp_large_pull_targets.Rmd</code></a></small>
      <div class="d-none name"><code>wqp_large_pull_targets.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>The Water Quality Portal (<a href="https://www.waterqualitydata.us/" class="external-link">WQP</a>) database aggregates and
standardizes discrete water quality data from numerous federal, state,
tribal, and other monitoring agencies. The WQP enables the access and
retrieval of over 297,000,000 water quality records (Read et al. 2017)
through web services and an application programming interface (API) that
can be called programmatically using the <a href="https://cran.r-project.org/web/packages/dataRetrieval/vignettes/dataRetrieval.html" class="external-link"><code>dataRetrieval</code></a>
package in R. Downloading data from the WQP represents a common pattern
across USGS data teams.</p>
<p>In this post, we highlight an <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/" class="external-link">example
data pipeline</a> to increase the reusability, reproducibility, and
efficiency of WQP data workflows. This post is an alternative method to
the script-based workflow presented in <a href="wqp_large_pull_script.html">Large Data Pulls from Water Quality
Portal - A Script-Based Approach</a>. We’ve designed it with large-scale
data pulls in mind, but this example pipeline will work at any spatial
or temporal scale.</p>
</div>
<div class="section level2">
<h2 id="why-targets">Why targets?<a class="anchor" aria-label="anchor" href="#why-targets"></a>
</h2>
<p>The workflow described here uses the <a href="https://books.ropensci.org/targets/" class="external-link"><code>targets</code></a>
package to leverage modular functions, dependency tracking, and
automated workflows to inventory and download data from the Water
Quality Portal. Using <code>targets</code> allows the user to develop a
maintainable pipeline that tracks changes over time and will only re-run
portions of the workflow that are out of date due to those changes.</p>
<p>The basic ingredient of a <code>targets</code> workflow is a script
file named <code>_targets.R</code>. This file is used to define and
configure all of the steps in an analysis pipeline and their connections
to each other. After connecting the individual analysis steps (also
known as targets) in the <code>_targets</code> file, the
<code>targets</code> package can then track the relationships between
each connection. Analysis steps that precede any given step of interest
are considered “upstream” while the analysis steps that follow are
considered “downstream”. Once these connections have been established,
<code>targets</code> can also visualize the relationships in a network
graph like the one shown below. The WQP pipeline is structured so that
various inputs - including the date range, spatial extent, parameters of
interest, and/or specific arguments to pass along to WQP queries - can
all be modified within the <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/main/_targets.R" class="external-link"><code>_targets.R</code></a>
file.</p>
<p><img src="full_pipeline.png" alt="A diagram that depicts the different components of a targets workflow. A targets workflow diagram tracks all portions of a data analysis workflow and their dependencies. In this workflow the targets in green are current and the targets in blue are out of date, needing to be re-run." width="375px" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="pulling-data-from-the-water-quality-portal">Pulling data from the Water Quality Portal<a class="anchor" aria-label="anchor" href="#pulling-data-from-the-water-quality-portal"></a>
</h2>
<p>The WQP targets pipeline is divided into three phases that divide the
workflow:</p>
<ol style="list-style-type: decimal">
<li>
<a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/main/1_inventory.R" class="external-link"><strong>Inventory</strong></a>
what sites and records are available in the WQP<br>
</li>
<li>
<a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/main/2_download.R" class="external-link"><strong>Download</strong></a>
the inventoried data<br>
</li>
<li>
<a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/main/3_harmonize.R" class="external-link"><strong>Harmonize</strong></a>,
or clean, the downloaded data to prepare the dataset for further
analysis</li>
</ol>
<p>This post will focus on how to carry out bulk data pulls using the
first two phases of the pipeline.</p>
<div class="section level3">
<h3 id="decide-which-characteristic-names-to-query">Decide which characteristic names to query<a class="anchor" aria-label="anchor" href="#decide-which-characteristic-names-to-query"></a>
</h3>
<p>The first step is to decide which water quality parameters should be
included in the data pull. One challenge posed by the aggregated WQP
database is that many characteristic names may refer to the same water
quality parameter (e.g., temperature records can take on different
values for <code>CharacteristicName</code>, including
<code>"Temperature"</code> or <code>"Temperature, water"</code>). The
WQP pipeline includes a configuration file to help map various WQP
characteristics onto more commonly-used parameter groups (<a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/main/1_inventory/cfg/wqp_codes.yml" class="external-link"><code>1_inventory/cfg/wqp_codes.yml</code></a>).</p>
<p>Here we are interested in compiling temperature data, so we define
this parameter group within <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/main/_targets.R#L24" class="external-link"><code>_targets.R</code></a>.</p>
<p>The characteristic names belonging to “temperature” are parsed in <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/5d7eaec10172f22abe0eaaa7f3934e303252a0dd/1_inventory.R#L32-L35" class="external-link"><code>p1_char_names</code></a>
to create a vector of <code>CharacteristicName</code> values that are
then used as input to the WQP query. Which values of
<code>CharacteristicName</code> to include may vary depending on the
needs of a specific project and which entries are considered valid in
WQP, which can change over time. To accommodate this variability, the
configuration file can be edited to omit certain characteristic names or
include new ones. For example, we might think of a new characteristic
name that contains temperature records and add that to the configuration
file. This simple example illustrates a decision that users of WQP data
must make, but that can sometimes be difficult to do so with confidence
(i.e., <em>is “temp” really a valid characteristic name?</em>). Two
pipeline features are designed to assist the user when making these
decisions. First, all requested characteristic names from the
configuration file are checked against a list of valid entries in WQP,
and will notify the user if a characteristic name is not valid.</p>
<p><img src="pipeline_snap_char_names.png" alt="A screenshot of the R console output for the example pipeline. The console output indicates that the wqp characteristic target named p1_char_names and all of the associated upstream targets are building. After building the console warns that the temp characteristic does not exist in the water quality portal. This warning message is one of the two pipeline features that can help the user determine whether or not they have specified a valid characteristic name." width="850px"></p>
<p>So we can see that our newly-added characteristic name “temp” is not
a valid entry and can be omitted from the configuration file. Second, a
user may wonder whether there are other characteristic names they might
have missed. The pipeline includes a target <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/5d7eaec10172f22abe0eaaa7f3934e303252a0dd/1_inventory.R#L37-L43" class="external-link"><code>p1_similar_char_names_txt</code></a>
that uses <a href="https://en.wikipedia.org/wiki/Approximate_string_matching" class="external-link">fuzzy
string matching</a> to check for valid characteristics that are similar
to the requested parameters, and return an output file that can be
evaluated by the user.</p>
<p>In <code>p1_char_names</code> we end up with a list of characteristic
names to use in the query:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">tar_load</span>(p1_char_names)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> p1_char_names</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"Temperature"</span>               <span class="st">"Temperature, sample"</span>       <span class="st">"Temperature, water"</span>        <span class="st">"Temperature, water, deg F"</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-the-area-of-interest">Define the area of interest<a class="anchor" aria-label="anchor" href="#define-the-area-of-interest"></a>
</h3>
<p>The next step is to define the spatial extent of the data pull. In
this example, we are requesting data for a triangular “watershed”
northwest of Philadelphia, PA, which we’ve specified in <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/5d7eaec10172f22abe0eaaa7f3934e303252a0dd/_targets.R#L26-L29" class="external-link"><code>_targets.R</code></a>
using a set of latitude and longitude coordinates.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify coordinates that define the spatial area of interest</span></span>
<span><span class="co"># lat/lon are referenced to WGS84</span></span>
<span><span class="va">coords_lon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">77.063</span>, <span class="op">-</span><span class="fl">75.333</span>, <span class="op">-</span><span class="fl">75.437</span><span class="op">)</span></span>
<span><span class="va">coords_lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40.547</span>, <span class="fl">41.029</span>, <span class="fl">39.880</span><span class="op">)</span></span></code></pre></div>
<p>Although we use spatial coordinates, a user could also easily use
other, predefined boundaries by replacing the targets <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/main/1_inventory.R#L50-L62" class="external-link"><code>p1_AOI</code>
and <code>p1_AOI_sf</code></a> with targets that download and read in an
external shapefile:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download a shapefile containing the Delaware River Basin boundary</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    p1_shp_zip,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      fileout <span class="ot">&lt;-</span> <span class="st">"1_inventory/out/drbbnd.zip"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      utils<span class="sc">::</span><span class="fu">download.file</span>(<span class="st">"https://www.state.nj.us/drbc/library/documents/GIS/drbbnd.zip"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">destfile =</span> fileout,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      fileout</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"file"</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Unzip the shapefile and read in as an sf polygon object</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    p1_AOI_sf,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      savedir <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(p1_shp_zip)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unzip</span>(<span class="at">zipfile =</span> p1_shp_zip, <span class="at">exdir =</span> savedir, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="fu">paste0</span>(savedir,<span class="st">"/drb_bnd_arc.shp"</span>), <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_cast</span>(.,<span class="st">"POLYGON"</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  ),</span></code></pre></div>
<p>In this example, the area of interest is relatively small and we
could probably request all of the temperature data within the boundary
of our triangular watershed without issue. However, what if we wanted to
download WQP data for the full state of Pennsylvania? This would result
in a much bigger request! The WQP pipeline is built around the central
idea that smaller queries to the WQP are more likely to succeed and
therefore, most workflows that pull WQP data would benefit from dividing
larger requests into smaller ones.</p>
<p>One way we break up larger data pulls is by using a set of grid cells
to define the spatial extent of multiple, smaller queries that, when
combined, represent a data inventory for the full area of interest. The
size of each grid cell can be customized by the user, but using 1 degree
cell sizes results in a set of five grid cells that overlap our example
watershed:</p>
<p><img src="map_original_grid_cells.png" alt="A screenshot of a map that includes the example watershed of interest, the grid cells used to chunk and query data from WQP, and a gray-scale background map on the northeastern United States. The map depicts the user-specified area of interest that is located near Philadephia Pennslyvania and defined in the p1_AOI_sf target and the five grid cells defined by the p1_global_grid_aoi target." width="475px" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="inventory-the-data-before-downloading">Inventory the data before downloading<a class="anchor" aria-label="anchor" href="#inventory-the-data-before-downloading"></a>
</h3>
<p>We use <code>targets</code> <a href="https://books.ropensci.org/targets/dynamic.html" class="external-link">“branching”</a>
capabilities to apply (or <em>map</em>) our data inventory and download
functions over each grid cell that overlaps our area of interest. The
user can quickly reference the number of sites and records that were
returned in the inventory by referencing a saved log file. If using the
pipeline along with <code>git</code> for version control, this log file
also allows a user to readily track changes to the data over the
time.</p>
<p><img src="log_file.png" alt="A screenshot of the log file csv generated by the pipeline. The log file includes a table with the following columns: characteristic name, number of sites, and number of records. The record depicted is for water temperature. It includes 504 sites and 8773 records." width="300px"></p>
</div>
<div class="section level3">
<h3 id="little-by-little-break-up-the-inventoried-sites-to-prepare-for-download">Little by little: break up the inventoried sites to prepare for
download<a class="anchor" aria-label="anchor" href="#little-by-little-break-up-the-inventoried-sites-to-prepare-for-download"></a>
</h3>
<p>The initial data inventory lets us know how many sites and records we
can expect for each unique <code>CharacteristicName</code> in our query.
Before actually downloading the data, we bin the inventoried sites
within each grid cell into distinct download groups so that the total
number of records in any given download group does not exceed a
user-specified maximum threshold (defaults to <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/99a90c159bcebc4d5ac2e90fbc85734547217a4a/2_download.R#L19-L21" class="external-link">250,000
records per download group</a>). This binning step acts as another
safeguard against timeout issues with large data requests, but also
allows us to take advantage of <code>targets</code> dependency tracking
to efficiently build or update the data pipeline. For example, we do not
have to re-download <em>all</em> of the data records from WQP just
because we added a new characteristic name or because new sites were
recently uploaded to WQP and detected in our inventory.
<code>targets</code> will only update those data subsets that become
“outdated” by an upstream change.</p>
</div>
<div class="section level3">
<h3 id="download-the-data">Download the data!<a class="anchor" aria-label="anchor" href="#download-the-data"></a>
</h3>
<p>We’re finally ready to download the data from the Water Quality
Portal and do so by mapping the function <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/main/2_download.R#L40-L46" class="external-link"><code>fetch_wqp_data()</code></a>
over each unique download group recombining the data in
<code>p2_wqp_data_aoi</code>. As a check on our downloaded data, we
compare the expected number of sites and records from <a href="https://github.com/USGS-R/ds-pipelines-targets-example-wqp/blob/main/2_download.R#L48-L54" class="external-link"><code>p1_wqp_inventory_summary_csv</code></a>
against the number of sites and records that were actually downloaded,
and inform the user of the result:</p>
<p><img src="pipeline_snap_check_inventory.png" alt="A screenshot of the R console output for the example pipeline. The console shows that temperature data has been retrieved from 228 sites. It also shows that the records downloaded match the records produced by the pipeline inventory. The output message reads: all good! the expected number of records from the WQP inventory matches the data pull for all characteristics." width="850px"></p>
</div>
<div class="section level3">
<h3 id="updating-the-data-pull">Updating the data pull<a class="anchor" aria-label="anchor" href="#updating-the-data-pull"></a>
</h3>
<p>As we mentioned above, <code>targets</code> dependency tracking
allows us to efficiently update our pipeline or expand our region of
interest without re-pulling grids that have already been queried. To
illustrate, say we decide to expand an analysis to include areas west of
our initial focal watershed. The map below shows that the area of
interest now overlaps six grid cells instead of five, but the five
original grids are still included in our query. Using common scripting
workflows we would usually just re-pull all of the data again even
though that is time-consuming.</p>
<p><img src="map_updated_grid_cells.png" alt="A screenshot of a map that includes the updated example watershed of interest, the grid cells used to chunk and query data from WQP, and a gray-scale background map on the northeastern United States. In this map the watershed of interest defined in p1_AOI_sf is bigger than in the first map and there are six grid cells in the p1_global_grid_aoi target." width="475px" style="display: block; margin: auto;"></p>
<p>However, <code>targets</code> recognizes that data has already been
inventoried for five of these grid cells and will only query data for
the newly-added grid, <code>46902</code>:</p>
<p><img src="pipeline_snap_update_inventory.png" alt="A screenshot of the R console output for the example pipeline that shows a partial rebuild of the p1_wqp_inventory target. After re-defining the area of interest, the pipeline rebuilds the inventory for the new grid cell in p1_global_grid_aoi target, but it doesn't need to rebuild the inventory from the other five grid cells because they have already been inventoried." width="600px"></p>
</div>
</div>
<div class="section level2">
<h2 id="customizing-the-pipeline">Customizing the pipeline<a class="anchor" aria-label="anchor" href="#customizing-the-pipeline"></a>
</h2>
<p>Our goal is for you to take this example pipeline and tailor it to
your own projects. Users can customize the spatial extent, the date
range, the list of water quality parameters of interest, and add new
functions for harmonizing data for various water quality
constituents.</p>
</div>
<div class="section level2">
<h2 id="disclaimer">Disclaimer<a class="anchor" aria-label="anchor" href="#disclaimer"></a>
</h2>
<p>Any use of trade, firm, or product names is for descriptive purposes
only and does not imply endorsement by the U.S. Government.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Read, E. K., Carr, L., De Cicco, L., Dugan, H. A., Hanson, P. C.,
Hart, J. A., Kreft, J., Read, J. S., and Winslow, L. A. (2017), Water
quality data for national-scale aquatic research: The Water Quality
Portal, Water Resour. Res., 53, 1735– 1745, <a href="https://agupubs.onlinelibrary.wiley.com/doi/10.1002/2016WR019993" class="external-link">doi:10.1002/2016WR019993</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer></footer>
</div> <!-- / div for your main content-->

<!-- BEGIN USGS Footer Template -->

<footer class="footer"><div class="tmp-container">
		<!-- .footer-wrap -->
			<!-- .footer-doi -->
			<div class="footer-doi">
				<!-- footer nav links -->
				<ul class="menu nav">
<li class="first leaf menu-links menu-level-1"><a href="https://www.doi.gov/privacy" class="external-link">DOI Privacy Policy</a></li>
					<li class="leaf menu-links menu-level-1"><a href="https://www.usgs.gov/policies-and-notices" class="external-link">Legal</a></li>
					<li class="leaf menu-links menu-level-1"><a href="https://www.usgs.gov/accessibility-and-us-geological-survey" class="external-link">Accessibility</a></li>
					<li class="leaf menu-links menu-level-1"><a href="https://www.usgs.gov/sitemap" class="external-link">Site Map</a></li>
					<li class="last leaf menu-links menu-level-1"><a href="https://answers.usgs.gov/" class="external-link">Contact USGS</a></li>
				</ul>
<!--/ footer nav links -->
</div>
			<!-- /.footer-doi -->

			<hr>
<!-- .footer-utl-links --><div class="footer-doi">
			<ul class="menu nav">
<li class="first leaf menu-links menu-level-1"><a href="https://www.doi.gov/" class="external-link">U.S. Department of the Interior</a></li>
				<li class="leaf menu-links menu-level-1"><a href="https://www.doioig.gov/" class="external-link">DOI Inspector General</a></li>
				<li class="leaf menu-links menu-level-1"><a href="https://www.whitehouse.gov/" class="external-link">White House</a></li>
				<li class="leaf menu-links menu-level-1"><a href="https://www.whitehouse.gov/omb/management/egov/" class="external-link">E-gov</a></li>
				<li class="leaf menu-links menu-level-1"><a href="https://www.doi.gov/pmb/eeo/no-fear-act" class="external-link">No Fear Act</a></li>
				<li class="last leaf menu-links menu-level-1"><a href="https://www.usgs.gov/about/organization/science-support/foia" class="external-link">FOIA</a></li>
			</ul>
</div>			
		<!-- /.footer-utl-links -->
		<!-- .footer-social-links -->
		<div class="footer-social-links">
			<ul class="social">
<li class="follow">Follow</li>
				<li class="twitter">
					<a href="https://twitter.com/usgs" target="_blank" class="external-link">
						<i class="fa fa-twitter-square"><span class="only">Twitter</span></i>
					</a>
				</li>
				<li class="facebook">
					<a href="https://facebook.com/usgeologicalsurvey" target="_blank" class="external-link">
						<i class="fa fa-facebook-square"><span class="only">Facebook</span></i>
					</a>
				</li>
				<li class="github">
					<a href="https://github.com/usgs" target="_blank" class="external-link">
						<i class="fa fa-github"><span class="only">GitHub</span></i>
					</a>
				</li>
				<li class="flickr">
					<a href="https://flickr.com/usgeologicalsurvey" target="_blank" class="external-link">
						<i class="fa fa-flickr"><span class="only">Flickr</span></i>
					</a>
				</li>
				<li class="youtube">
					<a href="http://youtube.com/usgs" target="_blank" class="external-link">
						<i class="fa fa-youtube-play"><span class="only">YouTube</span></i>
					</a>
				</li>
				<li class="instagram">
					<a href="https://instagram.com/usgs" target="_blank" class="external-link">
						<i class="fa fa-instagram"><span class="only">Instagram</span></i>
					</a>
				</li>
			</ul>
</div>
		<!-- /.footer-social-links -->
	</div>
		<!-- /.footer-wrap -->	
</footer><!-- END USGS Footer Template- --><!-- Google Tag Manager (noscript) --><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TKQR8KP" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  
  </body>
<!-- closing div for body -->
</html>
